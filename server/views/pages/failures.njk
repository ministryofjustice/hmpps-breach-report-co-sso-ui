{% extends "../partials/layout.njk" %}

{% set pageTitle = applicationName + " - Failures and Enforcement" %}
{% set mainClasses = "app-container govuk-body" %}

{% block content %}
  {% from "moj/components/side-navigation/macro.njk" import mojSideNavigation %}
  {% from "govuk/components/panel/macro.njk" import govukPanel %}
  {% from "govuk/components/button/macro.njk" import govukButton %}
  {% from "govuk/components/radios/macro.njk" import govukRadios %}
  {% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}
  {% from "govuk/components/details/macro.njk" import govukDetails %}
  {% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}



  <form method="post">

    {% set errorList =[
      { text: errorMessages.genericErrorMessage.text, href: "#" } if errorMessages.genericErrorMessage else None,
      { text: errorMessages.whyInBreach.text, href: "#whyInBreach" } if errorMessages.whyInBreach else None,
      { text: errorMessages.stepsToPreventBreach.text, href: "#stepsToPreventBreach" } if errorMessages.stepsToPreventBreach else None,
      { text: errorMessages.riskHistory.text, href: "#riskHistory" } if errorMessages.riskHistory else None,
      { text: errorMessages.supportingComments.text, href: "#supportingComments" } if errorMessages.supportingComments else None,
      { text: errorMessages.confirmEqualities.text, href: "#confirmationStatement" } if errorMessages.confirmEqualities else None
    ] | reject("undefined") %}

    {% if errorMessages | length > 0 %}
      {% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
      {{ govukErrorSummary({ titleText: "There is a problem", errorList: errorList }) }}
    {% endif %}

    <input type="hidden" name="_csrf" value="{{ csrfToken }}">

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-one-third">
        {% include "pages/side-nav.njk" %}
      </div>

      <div class="govuk-grid-column-two-thirds">

        {% if not showEmbeddedError %}

          <h1 id="page-title" class="govuk-heading-l">Breach Report CO SSO - Failures and Enforcement</h1>

          {% if failures.enforceableContacts | length > 0 %}
            <div class="govuk-form-group">
              <fieldset class="govuk-fieldset">
                <div class="govuk-checkboxes" data-module="govuk-checkboxes">
                  {% for failure in failures.enforceableContacts %}
                    <div class="govuk-checkboxes__item">
                      <input class="govuk-checkboxes__input" id="contact-{{ failure.id }}" name="contact" {% if failure.id in existingContacts %}checked="checked"{% endif %}
                             type="checkbox" value="{{ failure.id }}" data-aria-controls="conditional-{{ failure.id }}">
                      <label class="govuk-label govuk-checkboxes__label" for="contact-{{ failure.id }}">
                        {% set failureHtml = failure.notes | escape | nl2br | safe %}
                        {{ failure.datetime | toUserDate }}, {{ failure.type.description }}, {{ failure.outcome.description }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </fieldset>
            </div>
          {% endif %}


          {% set whyInBreachHelpHtml %}
            {{ govukDetails({
              summaryText: "What to include here",
              text: reasonHelp
            }) }}
          {% endset -%}
          {{ govukCharacterCount({
            label: {
              text: "Why is this person in breach?",
              classes: "govuk-label--m",
              isPageHeading: false
            },
            hint : {
              html: whyInBreachHelpHtml
            },
            value: cosso.whyInBreach,
            classes: "govuk-input--width-30",
            name: "whyInBreach",
            id: "whyInBreach",
            maxlength: 20000,
            errorMessage: {
              text: errorMessages.whyInBreach.text
            } if errorMessages.whyInBreach.text
          }) }}

          {% set stepsToPreventBreachHelpHtml %}
            {{ govukDetails({
              summaryText: "What to include here",
              text: preventHelp
            }) }}
          {% endset -%}
          {{ govukCharacterCount({
            label: {
              text: "What steps have been taken to prevent this breach?",
              classes: "govuk-label--m",
              isPageHeading: false
            },
            hint : {
              html: stepsToPreventBreachHelpHtml
            },
            value: cosso.stepsToPreventBreach,
            classes: "govuk-input--width-30",
            name: "stepsToPreventBreach",
            id: "stepsToPreventBreach",
            maxlength: 20000,
            errorMessage: {
              text: errorMessages.stepsToPreventBreach.text
            } if errorMessages.stepsToPreventBreach.text
          }) }}

          {% set registrationListHtml %}
            {% if failures.registrations | length > 0 %}
              {% for reg in failures.registrations %}
                <p id="registration-{{loop.index}}"> <span class="govuk-!-font-weight-bold">Type:</span> {{ reg.type.description }}<br/>
                  <span class="govuk-!-font-weight-bold">Category:</span> {{ reg.category.description }}<br/>
                  <span class="govuk-!-font-weight-bold">Level:</span> {{ reg.level.description }}<br/>
                  <span class="govuk-!-font-weight-bold">Start Date:</span> {{ req.startDate }}<br/>
                  <span class="govuk-!-font-weight-bold">End Date:</span> {{ req.endDate }}</p>
                {% if not loop.last %}
                  <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                {% endif %}
              {% endfor %}
            {% else %}
              <p>No registration details found</p>
            {% endif %}
          {% endset -%}
          {{ govukDetails({
            summaryText: "Show Registration History",
            html: registrationListHtml,
            classes: "govuk-label--m"
          }) }}

          {% set riskedHistoryHelpHtml %}
            {{ govukDetails({
              summaryText: "What to include here",
              text: riskHelp
            }) }}
          {% endset -%}
          {% set riskHistoryConditionalHtml %}
            {{ govukCharacterCount({
              hint : {
                html: riskedHistoryHelpHtml
              },
              value: cosso.riskHistory,
              classes: "govuk-input--width-30",
              name: "riskHistory",
              id: "riskHistory",
              maxlength: 20000,
              errorMessage: {
                text: errorMessages.riskHistory.text
              } if errorMessages.riskHistory.text
            }) }}
          {% endset -%}
          {{ govukRadios({
            name: "riskOfHarmChanged",
            fieldset: {
              legend: {
                text: "Has the Risk of Serious Harm changed since the order was imposed?",
                isPageHeading: false,
                classes: "govuk-fieldset__legend--m"
              }
            },
            hint: {
              text: "Identify if there have been changes in risk since this sentence was imposed."
            },
            items: [
              {
                value: "true",
                text: "Yes",
                checked: cosso.riskOfHarmChanged,
                conditional: {
                html: riskHistoryConditionalHtml
              }
              },
              {
                value: "false",
                text: "No",
                checked: not cosso.riskOfHarmChanged
              }
            ]
          }) }}

          {{ govukCheckboxes({
            name: "confirmationStatement",
            id: "confirmationStatement",
            fieldset: {
              legend: {
                text: "Confirmation Statement",
                isPageHeading: true,
                classes: "govuk-fieldset__legend--m"
              }
            },
            items: [
              {
                value: "true",
                text: "I confirm that equalities and diversity information has been considered as part of preparing the report and recommendations",
                checked: cosso.confirmEqualities === true
              }
            ],
            errorMessage: {
              text: errorMessages.confirmEqualities.text
            } if errorMessages.confirmEqualities.text
          }) }}

          {{ govukRadios({
            name: "recommendationOptions",
            value: cosso.recommendations,
            fieldset: {
              legend: {
                text: "Please select a recommendation",
                isPageHeading: false,
                classes: "govuk-fieldset__legend--m"
              }
            },
            items: [
              {
                value: "continued",
                text: "The Order is continued"
              },
              {
                value: "revoked",
                text: "The community order is revoked and the person be re-sentenced"
              },
              {
                value: "activated",
                text: "Custody is activated for the suspended sentence"
              }
            ]
          }) }}

          {% set supportingCommentsHelpHtml %}
            {{ govukDetails({
              summaryText: "What to include in your recommendation support statement",
              text: recommendationHelp
            }) }}
          {% endset -%}
          {{ govukCharacterCount({
            label: {
              text: "Comments to support the Recommendation",
              classes: "govuk-label--m",
              isPageHeading: false
            },
            hint : {
              html: supportingCommentsHelpHtml
            },
            value: cosso.supportingComments,
            classes: "govuk-input--width-30",
            name: "supportingComments",
            id: "supportingComments",
            maxlength: 20000,
            errorMessage: {
              text: errorMessages.supportingComments.text
            } if errorMessages.supportingComments.text
          }) }}

          <div class="moj-button-group">
            {{ govukButton({
              text: "Continue",
              preventDoubleClick: "true",
              type: "submit",
              attributes: {
                id: "continue-button"
              }
            }) }}
            {{ govukButton({
              text: "Save Progress and Close",
              type: "submit",
              name: "action",
              value: "saveProgressAndClose",
              classes: "govuk-button--secondary",
              attributes: {
                id: "close-button"
              }
            }) }}
          </div>

        {% endif %}
      </div>
    </div>

  </form>
{% endblock %}
